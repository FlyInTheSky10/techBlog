---
title: TCP 知识详解
date: 2022-03-06 21:38
categories:
- Linux
tags:
- Linux
- 计算机网络
- TCP
- 技术
---

# TCP 介绍

TCP提供了一种**面向连接的 (connection-oriented)、可靠**的**字节流服务**。术语“面向连接的”是指使用TCP的两个应用程序必须在它们可交换数据之前，通过相互联系来建立一个TCP连接。

当TCP接收到连接的另一端的数据时,它会发送一个**确认**。这个确认可能不会立即发送，而一般会延迟片刻。TCP使用的**ACK是累积**的，从某种意义来讲，一个指示字节号$N$的ACK暗示着所有直到$N$的字节(但不包含$N$)已经成功被接收了。这对于ACK丢失来说带来了一定的鲁棒性——如果一个ACK丢失，后续的ACK就足以确认前面的报文段了。

TCP给应用程序提供一种**双工服务**。这就是说数据可向两个方向流动，两个方向互相独立。因此，连接的每个端点必须对每个方向维持数据流的一个序列号。

每个TCP连接由一对**套接字或端点**（四元组，由客户机IP地址、客户机端口号、服务器IP地址以及服务器端口号组成）唯一地标识。

**序列号(Sequence Number)， seq**字段标识了TCP发送端到TCP接收端的数据流的一个字节,该字节代表着包含该序列号的报文段的数据中的第一个字节。TCP给每个字节赋予一个序列号。这个序列号是一个$32$位的无符号数,到达$2^{32}-1$后再循环回到0。**ACK**包含的值是该ACK(确认号)的发送方期待接收的下一个序列号。即最后被成功接收的数据字节的序列号加1。

当**建立一个新连接**时，从客户机发送至服务器的第一个报文段的SYN位字段被启用。 这样的报文段称为SYN报文段,或简单地称为**SYN**。然后序列号字段包含了在本次连接的这个方向上要使用的第一个序列号，后续序列号和返回的ACK号也在这个方向上(回想一 下，连接都是双向的)。注意这个数字不是0和1，而是另一个数字，经常是随机选择的，称为**初始序列号(Initial SequenceNumber, ISN)**。

SYN位字段会消耗一个序列号，消耗一个序列号也意味着使用重传进行**可靠传输**。不消耗序列号的ACK则不是。

# TCP 三次握手建立链接

![](../static/images/tcp1.png)

它们也常称作**三次握手** 。三次握手的目的不仅在于让通信双方了解一个连接正在建立,还在于利用数据包的选项来承载特殊的信息,**交换初始序列号(Initial Sequence Number, ISN)**。
<!-- more -->

# TCP 四次挥手关闭链接

## TCP 半关闭

![](../static/images/tcp2.png)

半关闭处于 TIME_WAIT 状态

# TCP 状态

![](../static/images/tcp3.png)

普通的客户端状态转移用深黑的实线箭头表示，而普通的服务器状态转换用虚线箭头表示。

将FIN\_WAIT\_1 、FIN\_WAIT\_2以及TIME\_WAIT状态用一个方框括起来(至少是部分被括起来),称作**“主动关闭”** 。它们表示当本地应用程序发起一个关闭请求时会进入的状态集合。另外两个状态(CLOSE\_WAIT与LAST\_ACK)被一个虚线框括起来，并标记为**“被动关闭” **

![](../static/images/tcp4.png)

**TIME\_WAIT状态**也称为2MSL等待状态。在该状态中，TCP将会等待两倍于最大段生存期(Maximum Segment Lifetime, MSL)的时间，有时也被称作加倍等待。每个实现都必须为最大段生存期选择一个数值。

在**TIME\_WAIT\_2状态**，某TCP通信端已发送一个FIN并已得到另一端的确认。除非出现半关闭的情况,否则该TCP端将会等待另一端的应用程序识别出自己已接收到一个文件末尾的通知并关闭这一端引起发送FIN的连接。只有当应用程序完成了这一关闭操作(它的 FIN已经被接收), 正在关闭的TCP连接才会从**FIN\_WAIT\_2**状态转移至**TIME\_WAIT**状态。 这意味着连接的一端能够依然永远保持这种状态。另一端也会依然处于**CLOSE\_WAIT**状态, 并且能永远维持这一状态直到应用程序决定宣布它的关闭。

如果负责主动关闭的应用程序执行的是一个完全关闭操作，而不是用一个半关闭来指明它还期望接收数据，那么就会设置一个计时器来避免接进入FIN\_WAIT\_2这一无限等待状。

# 实验

三次握手：

![](../static/images/tcp_ex1.png)

四次挥手：

![](../static/images/tcp_ex2.png)
