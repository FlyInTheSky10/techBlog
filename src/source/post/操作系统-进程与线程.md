---
title: 操作系统(一): 进程与线程
date: 2022-04-13 17:38
categories:
- Linux
tags:
- Linux
- 操作系统
- 技术
---

# 进程

**进程**是程序 (静态概念) 的一次运行 (动态概念)。每次运行需要操作系统为其分配必要资源 (在**内核空间**中的**内存标识符** **(mm_struct)**、**PCB** **(task_struct)** 等)，进程是系统**资源分配**和**调度**的**最小单位**。

Linux 中所有进程通过 **PCB** (进程控制块，Process Control Block，即 **task_struct**) 来多种组织关系。

PCB 是进程的唯一标识，其中包括：

- 进程描述信息：进程标识符、用户标识符
- 进程控制和管理信息：进程状态、进程优先级
- 资源分配清单：内存地址空间、虚拟地址空间、打开的文件、I/O 设备
- CPU 信息：CPU 中各个寄存器的值，保证进程切换后需要重启时能够从断点继续运行

PCB 使用**链表**组织，将具有相同状态的进程链在一起，形成各种队列。

Linux 根据 **ELF** **可执行文件**创建出**进程影像**，将代码部分拷贝至新进程虚存空间低地址部分 (code 部分)，然后将可执行文件中数据拷贝到高地址部分 (data 部分)

![内存模型中一个进程的影像](../static/images/os2.png)

<!-- more -->

## 进程状态

在一个进程的活动期间要具备三种基本状态：**运行状态、就绪状态、阻塞状态**

- 运行状态：该时刻进程占用 CPU
- 就绪状态：可运行，但由于其他进程处于运行状态导致该进程处于停止运行状态
- 阻塞状态：正等待某事件发生，即使此时刻给予其 CPU 控制权，也无法运行
- 阻塞挂起状态：进程在硬盘，并等待某个事件发生
- 就绪挂起状态：进程在硬盘，只要进入内存，就会马上运行

>  为什么需要挂起状态？

如果系统内存在大量阻塞进程，则会消耗大量的物理内存，在虚拟内存管理的系统中，会把阻塞态的进程从物理内存换出硬盘，在需要运行时，再从物理内存换入物理内存。

挂起不一定是系统挂起的，也可以是

- sleep 函数挂起进程，使用定时器，到期唤醒进程。
- 用户使用 Ctrl+Z 挂起进程

![进程状态图](../static/images/os1.png)

## 进程间组织关系

### 亲缘关系

一个进程创建一个子进程就形成**父子关系**。多个进程则形成**兄弟关系**。

这些关系可以利用各自的 task_struct 中的 parent、children 和 sibling 成员（都是 list_head 结构体，用 prev 和 next 指针指向前驱和后继）组织这些关系。

![进程间亲缘关系](../static/images/os3.png)

在 Linux 中，通过 `pstree` 命令，我们可以看到全系统的进程树结构。

### 会话、进程组、线程组及控制终端

Linux 下拥有多个**会话** (session)，每个会话包含多个**进程组** (process group)，每个进程组包含多个**进程**，每个进程构成一个**线程组**，一个线程组由进程内一个或多个**线程**组成。

- **会话**是用户登陆系统到退出前的全部活动，不同帐户的登录属于不同会话，而同一帐户的多次登录也构成不同的会话。
- 从登陆到结束前创建的所有进程都属于这次会话，第一个被创建的进程 (通常是 shell)称为会话的**领头进程** (session leader）
- 在 shell 上的一条命令所产生的所有进程形成一个进程组，每个进程组内第一个进程往往成为**领头进程** (process group leader)

## Linux 下进程控制

### 创建进程

### 撤销进程

### 守护进程

## 孤儿进程和僵尸进程

# 参考书籍及文章

1、小林 Coding - 进程与线程
[https://xiaolincoding.com/os/4_process/process_base.html#进程](https://xiaolincoding.com/os/4_process/process_base.html#进程)

2、《操作系统之编程观察》 罗秋明